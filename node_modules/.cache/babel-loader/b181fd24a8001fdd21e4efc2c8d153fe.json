{"ast":null,"code":"import _objectSpread from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport _objectWithoutProperties from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _regeneratorRuntime from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _defineProperty from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _classCallCheck from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/evan/progressMan/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport \"antd/lib/select/style\";\nimport _Select from \"antd/lib/select\";\nvar _jsxFileName = \"/Users/evan/progressMan/src/components/Form/model/table.js\";\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport DataTable from '../../DataTable';\nimport $$ from 'cmn-utils';\nimport isEqual from 'react-fast-compare';\nimport PageHelper from '@/utils/pageHelper';\nimport assign from 'object-assign';\nvar Pagination = DataTable.Pagination;\nvar Option = _Select.Option;\n/**\n *  formItem: {\n      type: 'table',\n      rowKey: 'id',\n      dataSource,\n      columns: innerColumns,\n      onChange: (form, value) => console.log('。。。:', value),\n      loadData: self.onLoadTableData,\n      initialValue: [11, 3, 5],\n    }\n */\n\nvar TableControlled =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(TableControlled, _Component);\n\n  function TableControlled(props) {\n    var _this;\n\n    _classCallCheck(this, TableControlled);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(TableControlled).call(this, props));\n\n    _this.onSelect = function (keys, rows) {\n      var _this$props = _this.props,\n          modal = _this$props.modal,\n          onChange = _this$props.onChange;\n\n      _this.setState({\n        value: keys,\n        rows: rows\n      });\n\n      if (onChange && !modal) {\n        onChange(keys, rows);\n      }\n    };\n\n    _this.onSelectChange = function (value, option) {\n      var _this$props2 = _this.props,\n          rowKey = _this$props2.rowKey,\n          onChange = _this$props2.onChange;\n      var rows = _this.state.rows;\n      var newRows = rows.filter(function (item) {\n        return value.indexOf(item[rowKey]) !== -1;\n      });\n\n      _this.setState({\n        value: value,\n        rows: newRows\n      });\n\n      onChange && onChange(value, newRows);\n    };\n\n    _this.showModal = function () {\n      _this.setState({\n        visible: true\n      });\n    };\n\n    _this.onSubmit = function () {\n      var _this$state = _this.state,\n          value = _this$state.value,\n          rows = _this$state.rows;\n      var onChange = _this.props.onChange;\n\n      _this.hideModal();\n\n      onChange && onChange(value, rows);\n    };\n\n    _this.hideModal = function () {\n      _this.setState({\n        visible: false\n      });\n    };\n\n    var _value2 = props.value,\n        dataSource = props.dataSource;\n    _this.state = {\n      value: _this.getKeys(_value2),\n      rows: _this.getRows(_value2),\n      dataSource: dataSource || PageHelper.create(),\n      visible: false,\n      loading: false\n    };\n    return _this;\n  }\n\n  _createClass(TableControlled, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var loadData = this.props.loadData;\n\n      if (loadData) {\n        this.onChange({\n          pageNum: 1\n        });\n      }\n    }\n  }, {\n    key: \"componentWillReceiveProps\",\n    value: function componentWillReceiveProps(nextProps) {\n      var dataSource = nextProps.dataSource,\n          value = nextProps.value,\n          loadData = nextProps.loadData;\n      var rows = this.state.rows;\n\n      if (!isEqual(this.props.dataSource, dataSource) || !isEqual(this.props.value, value)) {\n        var _value = this.getKeys(value);\n\n        var newState = {\n          value: _value,\n          rows: this.getRows(_value, rows)\n        };\n\n        if (!loadData && dataSource) {\n          newState.dataSource = dataSource;\n        }\n\n        this.setState(newState);\n      }\n    } // 将值转成对像数组\n\n  }, {\n    key: \"getRows\",\n    value: function getRows(value) {\n      var oldValue = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n      var rowKey = this.props.rowKey;\n\n      if (value) {\n        return value.map(function (item) {\n          var oldv = oldValue.filter(function (jtem) {\n            return jtem[rowKey] === item;\n          })[0];\n          return typeof item === 'object' ? item : oldv || _defineProperty({}, rowKey, item);\n        });\n      }\n\n      return [];\n    }\n  }, {\n    key: \"getKeys\",\n    value: function getKeys(value) {\n      var rowKey = this.props.rowKey;\n\n      if (value) {\n        return value.map(function (item) {\n          return $$.isObject(item) ? item[rowKey] : item;\n        });\n      }\n\n      return [];\n    }\n  }, {\n    key: \"onChange\",\n    value: function () {\n      var _onChange = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(_ref2) {\n        var pageNum, pageSize, loadData, dataSource, newDataSource;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                pageNum = _ref2.pageNum, pageSize = _ref2.pageSize;\n                loadData = this.props.loadData;\n                dataSource = this.state.dataSource;\n\n                if (!loadData) {\n                  _context.next = 9;\n                  break;\n                }\n\n                this.setState({\n                  loading: true\n                });\n                _context.next = 7;\n                return loadData(dataSource.jumpPage(pageNum, pageSize));\n\n              case 7:\n                newDataSource = _context.sent;\n                this.setState({\n                  loading: false,\n                  dataSource: assign(dataSource, newDataSource)\n                });\n\n              case 9:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function onChange(_x) {\n        return _onChange.apply(this, arguments);\n      }\n\n      return onChange;\n    }()\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this2 = this;\n\n      var _this$props3 = this.props,\n          modal = _this$props3.modal,\n          columns = _this$props3.columns,\n          titleKey = _this$props3.titleKey,\n          rowKey = _this$props3.rowKey,\n          selectType = _this$props3.selectType,\n          showNum = _this$props3.showNum,\n          placeholder = _this$props3.placeholder,\n          getPopupContainer = _this$props3.getPopupContainer,\n          disabled = _this$props3.disabled,\n          otherProps = _objectWithoutProperties(_this$props3, [\"modal\", \"columns\", \"titleKey\", \"rowKey\", \"selectType\", \"showNum\", \"placeholder\", \"getPopupContainer\", \"disabled\"]);\n\n      var _this$state2 = this.state,\n          dataSource = _this$state2.dataSource,\n          value = _this$state2.value,\n          rows = _this$state2.rows,\n          loading = _this$state2.loading,\n          visible = _this$state2.visible;\n      var dataTableProps = {\n        loading: loading,\n        columns: columns,\n        rowKey: rowKey,\n        dataItems: dataSource,\n        selectedRowKeys: value,\n        selectType: typeof selectType === 'undefined' ? 'checkbox' : selectType,\n        showNum: typeof showNum === 'undefined' ? true : showNum,\n        isScroll: true,\n        onChange: function onChange(_ref3) {\n          var pageNum = _ref3.pageNum,\n              pageSize = _ref3.pageSize;\n          return _this2.onChange({\n            pageNum: pageNum,\n            pageSize: pageSize\n          });\n        },\n        onSelect: function onSelect(keys, rows) {\n          return _this2.onSelect(keys, rows);\n        }\n      };\n\n      if (modal || disabled) {\n        return React.createElement(\"div\", {\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 184\n          },\n          __self: this\n        }, React.createElement(\"div\", {\n          onClick: disabled ? function () {} : this.showModal,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 185\n          },\n          __self: this\n        }, React.createElement(_Select, {\n          readOnly: true,\n          disabled: !!disabled,\n          mode: \"multiple\",\n          open: false,\n          value: titleKey ? value : value.length ? '_selected' : [],\n          onChange: this.onSelectChange,\n          placeholder: placeholder,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 186\n          },\n          __self: this\n        }, titleKey ? rows.map(function (item) {\n          return React.createElement(Option, {\n            key: item[rowKey],\n            value: item[rowKey],\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 197\n            },\n            __self: this\n          }, item[titleKey]);\n        }) : React.createElement(Option, {\n          key: \"_selected\",\n          value: \"_selected\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 202\n          },\n          __self: this\n        }, \"\\u5DF2\\u9009\\u62E9\", rows.length, \"\\u9879\"))), React.createElement(_Modal, Object.assign({\n          className: \"antui-table-modal\",\n          title: '请选择' + otherProps.title,\n          visible: visible,\n          width: modal.width || 600,\n          onCancel: this.hideModal,\n          footer: [React.createElement(Pagination, Object.assign({\n            key: \"paging\",\n            size: \"small\",\n            showSizeChanger: false,\n            showQuickJumper: false\n          }, dataTableProps, {\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 215\n            },\n            __self: this\n          })), React.createElement(_Button, {\n            key: \"back\",\n            onClick: this.hideModal,\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 222\n            },\n            __self: this\n          }, \"\\u53D6\\u6D88\"), React.createElement(_Button, {\n            key: \"submit\",\n            type: \"primary\",\n            onClick: this.onSubmit,\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 225\n            },\n            __self: this\n          }, \"\\u786E\\u5B9A\")]\n        }, modal, {\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 208\n          },\n          __self: this\n        }), React.createElement(DataTable, Object.assign({}, dataTableProps, {\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 231\n          },\n          __self: this\n        }))));\n      }\n\n      return React.createElement(DataTable, Object.assign({\n        pagination: {\n          showSizeChanger: false,\n          showQuickJumper: false\n        }\n      }, dataTableProps, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 238\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return TableControlled;\n}(Component);\n/**\n * TableForm组件\n */\n\n\nTableControlled.propTypes = {\n  value: PropTypes.array,\n  dataSource: PropTypes.object,\n  onChange: PropTypes.func,\n  loadData: PropTypes.func\n};\nTableControlled.defaultProps = {\n  rowKey: 'id',\n  modal: {}\n};\nexport default (function (_ref4) {\n  var form = _ref4.form,\n      name = _ref4.name,\n      _ref4$formFieldOption = _ref4.formFieldOptions,\n      formFieldOptions = _ref4$formFieldOption === void 0 ? {} : _ref4$formFieldOption,\n      record = _ref4.record,\n      initialValue = _ref4.initialValue,\n      rules = _ref4.rules,\n      onChange = _ref4.onChange,\n      dataSource = _ref4.dataSource,\n      normalize = _ref4.normalize,\n      rowKey = _ref4.rowKey,\n      placeholder = _ref4.placeholder,\n      otherProps = _objectWithoutProperties(_ref4, [\"form\", \"name\", \"formFieldOptions\", \"record\", \"initialValue\", \"rules\", \"onChange\", \"dataSource\", \"normalize\", \"rowKey\", \"placeholder\"]);\n\n  var getFieldDecorator = form.getFieldDecorator;\n  var initval = initialValue;\n\n  if (record) {\n    initval = record[name];\n  } // 如果存在初始值\n\n\n  if (initval !== null && typeof initval !== 'undefined') {\n    if ($$.isFunction(normalize)) {\n      formFieldOptions.initialValue = normalize(initval);\n    } else {\n      formFieldOptions.initialValue = initval;\n    }\n  } // 如果有rules\n\n\n  if (rules && rules.length) {\n    formFieldOptions.rules = rules;\n  } // 如果需要onChange\n\n\n  if (typeof onChange === 'function') {\n    formFieldOptions.onChange = function (value, rows) {\n      return onChange(form, value, rows);\n    }; // form, value\n\n  }\n\n  var props = _objectSpread({\n    placeholder: placeholder || \"\\u8BF7\\u9009\\u62E9\".concat(otherProps.title)\n  }, otherProps);\n\n  return getFieldDecorator(name, formFieldOptions)(React.createElement(TableControlled, Object.assign({\n    dataSource: dataSource,\n    rowKey: rowKey || name\n  }, props, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 299\n    },\n    __self: this\n  })));\n});","map":{"version":3,"sources":["/Users/evan/progressMan/src/components/Form/model/table.js"],"names":["React","Component","PropTypes","DataTable","$$","isEqual","PageHelper","assign","Pagination","Option","TableControlled","props","onSelect","keys","rows","modal","onChange","setState","value","onSelectChange","option","rowKey","state","newRows","filter","item","indexOf","showModal","visible","onSubmit","hideModal","dataSource","getKeys","getRows","create","loading","loadData","pageNum","nextProps","_value","newState","oldValue","map","oldv","jtem","isObject","pageSize","jumpPage","newDataSource","columns","titleKey","selectType","showNum","placeholder","getPopupContainer","disabled","otherProps","dataTableProps","dataItems","selectedRowKeys","isScroll","length","title","width","showSizeChanger","showQuickJumper","propTypes","array","object","func","defaultProps","form","name","formFieldOptions","record","initialValue","rules","normalize","getFieldDecorator","initval","isFunction"],"mappings":";;;;;;;;;;;;;;;;;AAAA,OAAOA,KAAP,IAAgBC,SAAhB,QAAiC,OAAjC;AACA,OAAOC,SAAP,MAAsB,YAAtB;AAEA,OAAOC,SAAP,MAAsB,iBAAtB;AACA,OAAOC,EAAP,MAAe,WAAf;AACA,OAAOC,OAAP,MAAoB,oBAApB;AACA,OAAOC,UAAP,MAAuB,oBAAvB;AACA,OAAOC,MAAP,MAAmB,eAAnB;AAEA,IAAMC,UAAU,GAAGL,SAAS,CAACK,UAA7B;AACA,IAAMC,MAAM,GAAG,QAAOA,MAAtB;AAEA;;;;;;;;;;;;IAWMC,e;;;;;AAaJ,2BAAYC,KAAZ,EAAmB;AAAA;;AAAA;;AACjB,yFAAMA,KAAN;;AADiB,UA2DnBC,QA3DmB,GA2DR,UAACC,IAAD,EAAOC,IAAP,EAAgB;AAAA,wBACG,MAAKH,KADR;AAAA,UACjBI,KADiB,eACjBA,KADiB;AAAA,UACVC,QADU,eACVA,QADU;;AAEzB,YAAKC,QAAL,CAAc;AAAEC,QAAAA,KAAK,EAAEL,IAAT;AAAeC,QAAAA,IAAI,EAAJA;AAAf,OAAd;;AAEA,UAAIE,QAAQ,IAAI,CAACD,KAAjB,EAAwB;AACtBC,QAAAA,QAAQ,CAACH,IAAD,EAAOC,IAAP,CAAR;AACD;AACF,KAlEkB;;AAAA,UAwFnBK,cAxFmB,GAwFF,UAACD,KAAD,EAAQE,MAAR,EAAmB;AAAA,yBACL,MAAKT,KADA;AAAA,UAC1BU,MAD0B,gBAC1BA,MAD0B;AAAA,UAClBL,QADkB,gBAClBA,QADkB;AAAA,UAE1BF,IAF0B,GAEjB,MAAKQ,KAFY,CAE1BR,IAF0B;AAGlC,UAAMS,OAAO,GAAGT,IAAI,CAACU,MAAL,CAAY,UAAAC,IAAI;AAAA,eAAIP,KAAK,CAACQ,OAAN,CAAcD,IAAI,CAACJ,MAAD,CAAlB,MAAgC,CAAC,CAArC;AAAA,OAAhB,CAAhB;;AACA,YAAKJ,QAAL,CAAc;AACZC,QAAAA,KAAK,EAALA,KADY;AAEZJ,QAAAA,IAAI,EAAES;AAFM,OAAd;;AAIAP,MAAAA,QAAQ,IAAIA,QAAQ,CAACE,KAAD,EAAQK,OAAR,CAApB;AACD,KAjGkB;;AAAA,UAmGnBI,SAnGmB,GAmGP,YAAM;AAChB,YAAKV,QAAL,CAAc;AACZW,QAAAA,OAAO,EAAE;AADG,OAAd;AAGD,KAvGkB;;AAAA,UAyGnBC,QAzGmB,GAyGR,YAAM;AAAA,wBACS,MAAKP,KADd;AAAA,UACPJ,KADO,eACPA,KADO;AAAA,UACAJ,IADA,eACAA,IADA;AAAA,UAEPE,QAFO,GAEM,MAAKL,KAFX,CAEPK,QAFO;;AAGf,YAAKc,SAAL;;AACAd,MAAAA,QAAQ,IAAIA,QAAQ,CAACE,KAAD,EAAQJ,IAAR,CAApB;AACD,KA9GkB;;AAAA,UAgHnBgB,SAhHmB,GAgHP,YAAM;AAChB,YAAKb,QAAL,CAAc;AACZW,QAAAA,OAAO,EAAE;AADG,OAAd;AAGD,KApHkB;;AAAA,QAETV,OAFS,GAEaP,KAFb,CAETO,KAFS;AAAA,QAEFa,UAFE,GAEapB,KAFb,CAEFoB,UAFE;AAGjB,UAAKT,KAAL,GAAa;AACXJ,MAAAA,KAAK,EAAE,MAAKc,OAAL,CAAad,OAAb,CADI;AAEXJ,MAAAA,IAAI,EAAE,MAAKmB,OAAL,CAAaf,OAAb,CAFK;AAGXa,MAAAA,UAAU,EAAEA,UAAU,IAAIzB,UAAU,CAAC4B,MAAX,EAHf;AAIXN,MAAAA,OAAO,EAAE,KAJE;AAKXO,MAAAA,OAAO,EAAE;AALE,KAAb;AAHiB;AAUlB;;;;wCAEmB;AAAA,UACVC,QADU,GACG,KAAKzB,KADR,CACVyB,QADU;;AAElB,UAAIA,QAAJ,EAAc;AACZ,aAAKpB,QAAL,CAAc;AAAEqB,UAAAA,OAAO,EAAE;AAAX,SAAd;AACD;AACF;;;8CAEyBC,S,EAAW;AAAA,UAC3BP,UAD2B,GACKO,SADL,CAC3BP,UAD2B;AAAA,UACfb,KADe,GACKoB,SADL,CACfpB,KADe;AAAA,UACRkB,QADQ,GACKE,SADL,CACRF,QADQ;AAAA,UAE3BtB,IAF2B,GAElB,KAAKQ,KAFa,CAE3BR,IAF2B;;AAGnC,UACE,CAACT,OAAO,CAAC,KAAKM,KAAL,CAAWoB,UAAZ,EAAwBA,UAAxB,CAAR,IACA,CAAC1B,OAAO,CAAC,KAAKM,KAAL,CAAWO,KAAZ,EAAmBA,KAAnB,CAFV,EAGE;AACA,YAAMqB,MAAM,GAAG,KAAKP,OAAL,CAAad,KAAb,CAAf;;AACA,YAAMsB,QAAQ,GAAG;AACftB,UAAAA,KAAK,EAAEqB,MADQ;AAEfzB,UAAAA,IAAI,EAAE,KAAKmB,OAAL,CAAaM,MAAb,EAAqBzB,IAArB;AAFS,SAAjB;;AAIA,YAAI,CAACsB,QAAD,IAAaL,UAAjB,EAA6B;AAC3BS,UAAAA,QAAQ,CAACT,UAAT,GAAsBA,UAAtB;AACD;;AAED,aAAKd,QAAL,CAAcuB,QAAd;AACD;AACF,K,CAED;;;;4BACQtB,K,EAAsB;AAAA,UAAfuB,QAAe,uEAAJ,EAAI;AAAA,UACpBpB,MADoB,GACT,KAAKV,KADI,CACpBU,MADoB;;AAE5B,UAAIH,KAAJ,EAAW;AACT,eAAOA,KAAK,CAACwB,GAAN,CAAU,UAAAjB,IAAI,EAAI;AACvB,cAAMkB,IAAI,GAAGF,QAAQ,CAACjB,MAAT,CAAgB,UAAAoB,IAAI;AAAA,mBAAIA,IAAI,CAACvB,MAAD,CAAJ,KAAiBI,IAArB;AAAA,WAApB,EAA+C,CAA/C,CAAb;AACA,iBAAO,OAAOA,IAAP,KAAgB,QAAhB,GAA2BA,IAA3B,GAAkCkB,IAAI,wBAAOtB,MAAP,EAAgBI,IAAhB,CAA7C;AACD,SAHM,CAAP;AAID;;AACD,aAAO,EAAP;AACD;;;4BAEOP,K,EAAO;AAAA,UACLG,MADK,GACM,KAAKV,KADX,CACLU,MADK;;AAEb,UAAIH,KAAJ,EAAW;AACT,eAAOA,KAAK,CAACwB,GAAN,CAAU,UAAAjB,IAAI;AAAA,iBAAKrB,EAAE,CAACyC,QAAH,CAAYpB,IAAZ,IAAoBA,IAAI,CAACJ,MAAD,CAAxB,GAAmCI,IAAxC;AAAA,SAAd,CAAP;AACD;;AACD,aAAO,EAAP;AACD;;;;;;;;;;;;AAWgBY,gBAAAA,O,SAAAA,O,EAASS,Q,SAAAA,Q;AAChBV,gBAAAA,Q,GAAa,KAAKzB,K,CAAlByB,Q;AACAL,gBAAAA,U,GAAe,KAAKT,K,CAApBS,U;;qBAEJK,Q;;;;;AACF,qBAAKnB,QAAL,CAAc;AACZkB,kBAAAA,OAAO,EAAE;AADG,iBAAd;;uBAI4BC,QAAQ,CAClCL,UAAU,CAACgB,QAAX,CAAoBV,OAApB,EAA6BS,QAA7B,CADkC,C;;;AAA9BE,gBAAAA,a;AAIN,qBAAK/B,QAAL,CAAc;AACZkB,kBAAAA,OAAO,EAAE,KADG;AAEZJ,kBAAAA,UAAU,EAAExB,MAAM,CAACwB,UAAD,EAAaiB,aAAb;AAFN,iBAAd;;;;;;;;;;;;;;;;;;6BAqCK;AAAA;;AAAA,yBAYH,KAAKrC,KAZF;AAAA,UAELI,KAFK,gBAELA,KAFK;AAAA,UAGLkC,OAHK,gBAGLA,OAHK;AAAA,UAILC,QAJK,gBAILA,QAJK;AAAA,UAKL7B,MALK,gBAKLA,MALK;AAAA,UAML8B,UANK,gBAMLA,UANK;AAAA,UAOLC,OAPK,gBAOLA,OAPK;AAAA,UAQLC,WARK,gBAQLA,WARK;AAAA,UASLC,iBATK,gBASLA,iBATK;AAAA,UAULC,QAVK,gBAULA,QAVK;AAAA,UAWFC,UAXE;;AAAA,yBAa+C,KAAKlC,KAbpD;AAAA,UAaCS,UAbD,gBAaCA,UAbD;AAAA,UAaab,KAbb,gBAaaA,KAbb;AAAA,UAaoBJ,IAbpB,gBAaoBA,IAbpB;AAAA,UAa0BqB,OAb1B,gBAa0BA,OAb1B;AAAA,UAamCP,OAbnC,gBAamCA,OAbnC;AAeP,UAAM6B,cAAc,GAAG;AACrBtB,QAAAA,OAAO,EAAPA,OADqB;AAErBc,QAAAA,OAAO,EAAPA,OAFqB;AAGrB5B,QAAAA,MAAM,EAANA,MAHqB;AAIrBqC,QAAAA,SAAS,EAAE3B,UAJU;AAKrB4B,QAAAA,eAAe,EAAEzC,KALI;AAMrBiC,QAAAA,UAAU,EAAE,OAAOA,UAAP,KAAsB,WAAtB,GAAoC,UAApC,GAAiDA,UANxC;AAOrBC,QAAAA,OAAO,EAAE,OAAOA,OAAP,KAAmB,WAAnB,GAAiC,IAAjC,GAAwCA,OAP5B;AAQrBQ,QAAAA,QAAQ,EAAE,IARW;AASrB5C,QAAAA,QAAQ,EAAE;AAAA,cAAGqB,OAAH,SAAGA,OAAH;AAAA,cAAYS,QAAZ,SAAYA,QAAZ;AAAA,iBAA2B,MAAI,CAAC9B,QAAL,CAAc;AAAEqB,YAAAA,OAAO,EAAPA,OAAF;AAAWS,YAAAA,QAAQ,EAARA;AAAX,WAAd,CAA3B;AAAA,SATW;AAUrBlC,QAAAA,QAAQ,EAAE,kBAACC,IAAD,EAAOC,IAAP;AAAA,iBAAgB,MAAI,CAACF,QAAL,CAAcC,IAAd,EAAoBC,IAApB,CAAhB;AAAA;AAVW,OAAvB;;AAYA,UAAIC,KAAK,IAAIwC,QAAb,EAAuB;AACrB,eACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WACE;AAAK,UAAA,OAAO,EAAEA,QAAQ,GAAG,YAAM,CAAE,CAAX,GAAc,KAAK5B,SAAzC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WACE;AACE,UAAA,QAAQ,MADV;AAEE,UAAA,QAAQ,EAAE,CAAC,CAAC4B,QAFd;AAGE,UAAA,IAAI,EAAC,UAHP;AAIE,UAAA,IAAI,EAAE,KAJR;AAKE,UAAA,KAAK,EAAEL,QAAQ,GAAGhC,KAAH,GAAWA,KAAK,CAAC2C,MAAN,GAAe,WAAf,GAA6B,EALzD;AAME,UAAA,QAAQ,EAAE,KAAK1C,cANjB;AAOE,UAAA,WAAW,EAAEkC,WAPf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WASGH,QAAQ,GACPpC,IAAI,CAAC4B,GAAL,CAAS,UAAAjB,IAAI;AAAA,iBACX,oBAAC,MAAD;AAAQ,YAAA,GAAG,EAAEA,IAAI,CAACJ,MAAD,CAAjB;AAA2B,YAAA,KAAK,EAAEI,IAAI,CAACJ,MAAD,CAAtC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aACGI,IAAI,CAACyB,QAAD,CADP,CADW;AAAA,SAAb,CADO,GAOP,oBAAC,MAAD;AAAQ,UAAA,GAAG,EAAC,WAAZ;AAAwB,UAAA,KAAK,EAAC,WAA9B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCACMpC,IAAI,CAAC+C,MADX,WAhBJ,CADF,CADF,EAwBE;AACE,UAAA,SAAS,EAAC,mBADZ;AAEE,UAAA,KAAK,EAAE,QAAQL,UAAU,CAACM,KAF5B;AAGE,UAAA,OAAO,EAAElC,OAHX;AAIE,UAAA,KAAK,EAAEb,KAAK,CAACgD,KAAN,IAAe,GAJxB;AAKE,UAAA,QAAQ,EAAE,KAAKjC,SALjB;AAME,UAAA,MAAM,EAAE,CACN,oBAAC,UAAD;AACE,YAAA,GAAG,EAAC,QADN;AAEE,YAAA,IAAI,EAAC,OAFP;AAGE,YAAA,eAAe,EAAE,KAHnB;AAIE,YAAA,eAAe,EAAE;AAJnB,aAKM2B,cALN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aADM,EAQN;AAAQ,YAAA,GAAG,EAAC,MAAZ;AAAmB,YAAA,OAAO,EAAE,KAAK3B,SAAjC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BARM,EAWN;AAAQ,YAAA,GAAG,EAAC,QAAZ;AAAqB,YAAA,IAAI,EAAC,SAA1B;AAAoC,YAAA,OAAO,EAAE,KAAKD,QAAlD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BAXM;AANV,WAqBMd,KArBN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAuBE,oBAAC,SAAD,oBAAe0C,cAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAvBF,CAxBF,CADF;AAoDD;;AAED,aACE,oBAAC,SAAD;AACE,QAAA,UAAU,EAAE;AACVO,UAAAA,eAAe,EAAE,KADP;AAEVC,UAAAA,eAAe,EAAE;AAFP;AADd,SAKMR,cALN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SADF;AASD;;;;EA9N2BxD,S;AAiO9B;;;;;AAjOMS,e,CACGwD,S,GAAY;AACjBhD,EAAAA,KAAK,EAAEhB,SAAS,CAACiE,KADA;AAEjBpC,EAAAA,UAAU,EAAE7B,SAAS,CAACkE,MAFL;AAGjBpD,EAAAA,QAAQ,EAAEd,SAAS,CAACmE,IAHH;AAIjBjC,EAAAA,QAAQ,EAAElC,SAAS,CAACmE;AAJH,C;AADf3D,e,CAQG4D,Y,GAAe;AACpBjD,EAAAA,MAAM,EAAE,IADY;AAEpBN,EAAAA,KAAK,EAAE;AAFa,C;AA4NxB,gBAAe,iBAaT;AAAA,MAZJwD,IAYI,SAZJA,IAYI;AAAA,MAXJC,IAWI,SAXJA,IAWI;AAAA,oCAVJC,gBAUI;AAAA,MAVJA,gBAUI,sCAVe,EAUf;AAAA,MATJC,MASI,SATJA,MASI;AAAA,MARJC,YAQI,SARJA,YAQI;AAAA,MAPJC,KAOI,SAPJA,KAOI;AAAA,MANJ5D,QAMI,SANJA,QAMI;AAAA,MALJe,UAKI,SALJA,UAKI;AAAA,MAJJ8C,SAII,SAJJA,SAII;AAAA,MAHJxD,MAGI,SAHJA,MAGI;AAAA,MAFJgC,WAEI,SAFJA,WAEI;AAAA,MADDG,UACC;;AAAA,MACIsB,iBADJ,GAC0BP,IAD1B,CACIO,iBADJ;AAGJ,MAAIC,OAAO,GAAGJ,YAAd;;AAEA,MAAID,MAAJ,EAAY;AACVK,IAAAA,OAAO,GAAGL,MAAM,CAACF,IAAD,CAAhB;AACD,GAPG,CASJ;;;AACA,MAAIO,OAAO,KAAK,IAAZ,IAAoB,OAAOA,OAAP,KAAmB,WAA3C,EAAwD;AACtD,QAAI3E,EAAE,CAAC4E,UAAH,CAAcH,SAAd,CAAJ,EAA8B;AAC5BJ,MAAAA,gBAAgB,CAACE,YAAjB,GAAgCE,SAAS,CAACE,OAAD,CAAzC;AACD,KAFD,MAEO;AACLN,MAAAA,gBAAgB,CAACE,YAAjB,GAAgCI,OAAhC;AACD;AACF,GAhBG,CAkBJ;;;AACA,MAAIH,KAAK,IAAIA,KAAK,CAACf,MAAnB,EAA2B;AACzBY,IAAAA,gBAAgB,CAACG,KAAjB,GAAyBA,KAAzB;AACD,GArBG,CAuBJ;;;AACA,MAAI,OAAO5D,QAAP,KAAoB,UAAxB,EAAoC;AAClCyD,IAAAA,gBAAgB,CAACzD,QAAjB,GAA4B,UAACE,KAAD,EAAQJ,IAAR;AAAA,aAAiBE,QAAQ,CAACuD,IAAD,EAAOrD,KAAP,EAAcJ,IAAd,CAAzB;AAAA,KAA5B,CADkC,CACwC;;AAC3E;;AAED,MAAMH,KAAK;AACT0C,IAAAA,WAAW,EAAEA,WAAW,gCAAUG,UAAU,CAACM,KAArB;AADf,KAENN,UAFM,CAAX;;AAKA,SAAOsB,iBAAiB,CAACN,IAAD,EAAOC,gBAAP,CAAjB,CACL,oBAAC,eAAD;AACE,IAAA,UAAU,EAAE1C,UADd;AAEE,IAAA,MAAM,EAAEV,MAAM,IAAImD;AAFpB,KAGM7D,KAHN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KADK,CAAP;AAOD,CArDD","sourcesContent":["import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { Modal, Button, Select } from 'antd';\nimport DataTable from '../../DataTable';\nimport $$ from 'cmn-utils';\nimport isEqual from 'react-fast-compare';\nimport PageHelper from '@/utils/pageHelper';\nimport assign from 'object-assign';\n\nconst Pagination = DataTable.Pagination;\nconst Option = Select.Option;\n\n/**\n *  formItem: {\n      type: 'table',\n      rowKey: 'id',\n      dataSource,\n      columns: innerColumns,\n      onChange: (form, value) => console.log('。。。:', value),\n      loadData: self.onLoadTableData,\n      initialValue: [11, 3, 5],\n    }\n */\nclass TableControlled extends Component {\n  static propTypes = {\n    value: PropTypes.array,\n    dataSource: PropTypes.object,\n    onChange: PropTypes.func,\n    loadData: PropTypes.func\n  };\n\n  static defaultProps = {\n    rowKey: 'id',\n    modal: {}\n  };\n\n  constructor(props) {\n    super(props);\n    const { value, dataSource } = props;\n    this.state = {\n      value: this.getKeys(value),\n      rows: this.getRows(value),\n      dataSource: dataSource || PageHelper.create(),\n      visible: false,\n      loading: false\n    };\n  }\n\n  componentDidMount() {\n    const { loadData } = this.props;\n    if (loadData) {\n      this.onChange({ pageNum: 1 });\n    }\n  }\n\n  componentWillReceiveProps(nextProps) {\n    const { dataSource, value, loadData } = nextProps;\n    const { rows } = this.state;\n    if (\n      !isEqual(this.props.dataSource, dataSource) ||\n      !isEqual(this.props.value, value)\n    ) {\n      const _value = this.getKeys(value);\n      const newState = {\n        value: _value,\n        rows: this.getRows(_value, rows)\n      };\n      if (!loadData && dataSource) {\n        newState.dataSource = dataSource;\n      }\n\n      this.setState(newState);\n    }\n  }\n\n  // 将值转成对像数组\n  getRows(value, oldValue = []) {\n    const { rowKey } = this.props;\n    if (value) {\n      return value.map(item => {\n        const oldv = oldValue.filter(jtem => jtem[rowKey] === item)[0];\n        return typeof item === 'object' ? item : oldv || { [rowKey]: item };\n      });\n    }\n    return [];\n  }\n\n  getKeys(value) {\n    const { rowKey } = this.props;\n    if (value) {\n      return value.map(item => ($$.isObject(item) ? item[rowKey] : item));\n    }\n    return [];\n  }\n\n  onSelect = (keys, rows) => {\n    const { modal, onChange } = this.props;\n    this.setState({ value: keys, rows });\n\n    if (onChange && !modal) {\n      onChange(keys, rows);\n    }\n  };\n\n  async onChange({ pageNum, pageSize }) {\n    const { loadData } = this.props;\n    const { dataSource } = this.state;\n\n    if (loadData) {\n      this.setState({\n        loading: true\n      });\n\n      const newDataSource = await loadData(\n        dataSource.jumpPage(pageNum, pageSize)\n      );\n\n      this.setState({\n        loading: false,\n        dataSource: assign(dataSource, newDataSource)\n      });\n    }\n  }\n\n  onSelectChange = (value, option) => {\n    const { rowKey, onChange } = this.props;\n    const { rows } = this.state;\n    const newRows = rows.filter(item => value.indexOf(item[rowKey]) !== -1);\n    this.setState({\n      value,\n      rows: newRows\n    });\n    onChange && onChange(value, newRows);\n  };\n\n  showModal = () => {\n    this.setState({\n      visible: true\n    });\n  };\n\n  onSubmit = () => {\n    const { value, rows } = this.state;\n    const { onChange } = this.props;\n    this.hideModal();\n    onChange && onChange(value, rows);\n  };\n\n  hideModal = () => {\n    this.setState({\n      visible: false\n    });\n  };\n\n  render() {\n    const {\n      modal,\n      columns,\n      titleKey,\n      rowKey,\n      selectType,\n      showNum,\n      placeholder,\n      getPopupContainer,\n      disabled,\n      ...otherProps\n    } = this.props;\n    const { dataSource, value, rows, loading, visible } = this.state;\n\n    const dataTableProps = {\n      loading,\n      columns,\n      rowKey,\n      dataItems: dataSource,\n      selectedRowKeys: value,\n      selectType: typeof selectType === 'undefined' ? 'checkbox' : selectType,\n      showNum: typeof showNum === 'undefined' ? true : showNum,\n      isScroll: true,\n      onChange: ({ pageNum, pageSize }) => this.onChange({ pageNum, pageSize }),\n      onSelect: (keys, rows) => this.onSelect(keys, rows)\n    };\n    if (modal || disabled) {\n      return (\n        <div>\n          <div onClick={disabled ? () => {} : this.showModal}>\n            <Select\n              readOnly\n              disabled={!!disabled}\n              mode=\"multiple\"\n              open={false}\n              value={titleKey ? value : value.length ? '_selected' : []}\n              onChange={this.onSelectChange}\n              placeholder={placeholder}\n            >\n              {titleKey ? (\n                rows.map(item => (\n                  <Option key={item[rowKey]} value={item[rowKey]}>\n                    {item[titleKey]}\n                  </Option>\n                ))\n              ) : (\n                <Option key=\"_selected\" value=\"_selected\">\n                  已选择{rows.length}项\n                </Option>\n              )}\n            </Select>\n          </div>\n          <Modal\n            className=\"antui-table-modal\"\n            title={'请选择' + otherProps.title}\n            visible={visible}\n            width={modal.width || 600}\n            onCancel={this.hideModal}\n            footer={[\n              <Pagination\n                key=\"paging\"\n                size=\"small\"\n                showSizeChanger={false}\n                showQuickJumper={false}\n                {...dataTableProps}\n              />,\n              <Button key=\"back\" onClick={this.hideModal}>\n                取消\n              </Button>,\n              <Button key=\"submit\" type=\"primary\" onClick={this.onSubmit}>\n                确定\n              </Button>\n            ]}\n            {...modal}\n          >\n            <DataTable {...dataTableProps} />\n          </Modal>\n        </div>\n      );\n    }\n\n    return (\n      <DataTable\n        pagination={{\n          showSizeChanger: false,\n          showQuickJumper: false\n        }}\n        {...dataTableProps}\n      />\n    );\n  }\n}\n\n/**\n * TableForm组件\n */\nexport default ({\n  form,\n  name,\n  formFieldOptions = {},\n  record,\n  initialValue,\n  rules,\n  onChange,\n  dataSource,\n  normalize,\n  rowKey,\n  placeholder,\n  ...otherProps\n}) => {\n  const { getFieldDecorator } = form;\n\n  let initval = initialValue;\n\n  if (record) {\n    initval = record[name];\n  }\n\n  // 如果存在初始值\n  if (initval !== null && typeof initval !== 'undefined') {\n    if ($$.isFunction(normalize)) {\n      formFieldOptions.initialValue = normalize(initval);\n    } else {\n      formFieldOptions.initialValue = initval;\n    }\n  }\n\n  // 如果有rules\n  if (rules && rules.length) {\n    formFieldOptions.rules = rules;\n  }\n\n  // 如果需要onChange\n  if (typeof onChange === 'function') {\n    formFieldOptions.onChange = (value, rows) => onChange(form, value, rows); // form, value\n  }\n\n  const props = {\n    placeholder: placeholder || `请选择${otherProps.title}`,\n    ...otherProps\n  };\n\n  return getFieldDecorator(name, formFieldOptions)(\n    <TableControlled\n      dataSource={dataSource}\n      rowKey={rowKey || name}\n      {...props}\n    />\n  );\n};\n"]},"metadata":{},"sourceType":"module"}